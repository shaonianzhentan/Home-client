<html>
<head>
<title>FM收音机</title>
<link rel="stylesheet" href="http://cdn.bootcss.com/animate.css/3.2.0/animate.min.css">
<link href="http://cdn.bootcss.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<link href="http://cdn.bootcss.com/Buttons/2.0.0/css/buttons.min.css" rel="stylesheet">
<script src="http://cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script>
<script src="http://cdn.bootcss.com/Buttons/2.0.0/js/buttons.min.js"></script>
<script src="http://cdn.bootcss.com/hls.js/0.7.10/hls.min.js"></script>

<style type="text/css">
body{overflow:hidden;}
.fa{font-size: 100px;}
@-webkit-keyframes rotation{
	from {-webkit-transform: rotate(0deg);}
	to {-webkit-transform: rotate(360deg);}
}
.Rotation{
	-webkit-transform: rotate(360deg);
	animation: rotation 3s linear infinite;
	-moz-animation: rotation 3s linear infinite;
	-webkit-animation: rotation 3s linear infinite;
	-o-animation: rotation 3s linear infinite;
}
</style>
</head>
<body>


<div style="display:none;">
<h1 id="HlsStatus"></h1>
<video id="video"></video>
</div>
<div id="btn" style="position:absolute;top:50%;left:50%;margin-top:-150px;margin-left:-100px;">
 <span class="button-wrap" onclick="run()">
    <button class="button button-circle button-raised button-primary" style="width:200px;height:200px;background:#009688;border-color:#009688;">
      <i class="fa fa-refresh"></i>
    </button>
  </span>
</div>

<script>

var arr = [], playIndex,video;

function run(index){
	$("#btn").addClass("Rotation");
	if(index == null){
		playIndex = index = Math.floor(Math.random() * (arr.length-1));	
	}else{
		if(index >= arr.length) index = 0;
		if(index < 0) index = arr.length-1;
		playIndex = index; 
	}
	var obj = arr[index];
	var video_url = obj.url;
	console.log(index,video_url);
	//var video_url = 'http://qg2.cnr.cn/live/cqyygb/playlist.m3u8';
	if(Hls.isSupported()) {
		video = document.getElementById('video');				
		var hls = new Hls();
		hls.loadSource(video_url);
		hls.attachMedia(video);
		hls.on(Hls.Events.MANIFEST_PARSED,function() {
		  video.play();
		  $("#btn").removeClass("Rotation");
		});	
		
		hls.on(Hls.Events.ERROR, function(event,data) {
        console.warn(data);
		
        switch(data.details) {
          case Hls.ErrorDetails.MANIFEST_LOAD_ERROR:
		  case Hls.ErrorDetails.LEVEL_LOAD_ERROR:
		  case Hls.ErrorDetails.MANIFEST_LOAD_TIMEOUT:
            run();
            break;
          case Hls.ErrorDetails.MANIFEST_PARSING_ERROR:
            $("#HlsStatus").text("error while parsing manifest:" + data.reason);
            break;          
          case Hls.ErrorDetails.LEVEL_LOAD_TIMEOUT:
            $("#HlsStatus").text("timeout while loading level playlist");
            break;
          case Hls.ErrorDetails.LEVEL_SWITCH_ERROR:
            $("#HlsStatus").text("error while trying to switch to level " + data.level);
            break;
          case Hls.ErrorDetails.FRAG_LOAD_ERROR:
            $("#HlsStatus").text("error while loading fragment " + data.frag.url);
            break;
          case Hls.ErrorDetails.FRAG_LOAD_TIMEOUT:
            $("#HlsStatus").text("timeout while loading fragment " + data.frag.url);
            break;
          case Hls.ErrorDetails.FRAG_LOOP_LOADING_ERROR:
            $("#HlsStatus").text("Frag Loop Loading Error");
            break;
          case Hls.ErrorDetails.FRAG_DECRYPT_ERROR:
            $("#HlsStatus").text("Decrypting Error:" + data.reason);
            break;
          case Hls.ErrorDetails.FRAG_PARSING_ERROR:
            $("#HlsStatus").text("Parsing Error:" + data.reason);
            break;
          case Hls.ErrorDetails.KEY_LOAD_ERROR:
            $("#HlsStatus").text("error while loading key " + data.frag.decryptdata.uri);
            break;
          case Hls.ErrorDetails.KEY_LOAD_TIMEOUT:
            $("#HlsStatus").text("timeout while loading key " + data.frag.decryptdata.uri);
            break;
          case Hls.ErrorDetails.BUFFER_APPEND_ERROR:
            $("#HlsStatus").text("Buffer Append Error");
            break;
          case Hls.ErrorDetails.BUFFER_ADD_CODEC_ERROR:
            $("#HlsStatus").text("Buffer Add Codec Error for " + data.mimeType + ":" + data.err.message);
            break;
          case Hls.ErrorDetails.BUFFER_APPENDING_ERROR:
            $("#HlsStatus").text("Buffer Appending Error");
            break;
          default:
            break;
        }
		
        if(data.fatal) {
          console.log('fatal error :' + data.details);
          switch(data.type) {
            case Hls.ErrorTypes.MEDIA_ERROR:
              run();
              break;
            case Hls.ErrorTypes.NETWORK_ERROR:
              //$("#HlsStatus").append(",network error ...");
              break;
            default:
              //$("#HlsStatus").append(", unrecoverable error");
              hls.destroy();
              break;
          }
          console.log($("#HlsStatus").text());
        }
       });		
	}
}
 
$.get("radio.txt",function(data){

	data = JSON.parse(data);
		console.log(data);

	for(var k in data){
		data[k].forEach(function(ele){
			arr.push({
				title : ele.title,
				author : k,
				url : ele.url
			})
		})
	}
	
	run();
	
})

function prev(){	
	run(--playIndex);
}

function next(){	
	run(++playIndex);
}
</script>
</body>
</html>